# 并发执行 XiaoBuild 命令 #

> 此功能仅适用于 XiaoBuild 的 企业版本。

使用此功能，即可在 Initiator 机器上并行运行多个 XiaoBuild 执行。用户可以并行执行 Visual Studio 编译、BuildConsole 命令、IBConsole 命令，或任意上述组合。

默认关闭对并行执行多个 XiaoBuild 执行的支持。要启用此功能，请前往 XiaoBuild 代理 -> Initiator -> Multiple Builds，然后选择最符合您需求的配置。


> 与 XiaoBuild 并发执行相关的场景

此功能尤其适用于以下场景：

* 正在构建服务器中并发执行构建 - 当若干开发人员共同处理单个构建服务器，或在持续集成、持续交付周期中工作，特别是当多个开发人员发布了同一个将要在构建机器上并发执行的构建时，构建均经常需要并行运行。
  
* 并行执行多个解决方案 - 这种情况存在于多种场景，特别是能够并行执行多个 C# 解决方案的 C# 开发场景。如果能够与 XiaoBuild 将解决方案项目编译任务分发至远端机器的能力相结合，以并行执行多个解决方案，那么用于执行完整构建周期的总耗时将会大大缩短。

* 在多种场景中使用 XiaoBuild 并行执行作业，可大大缩短构建周期总耗时。例如，并行运行集成测试，或是在执行后构建步骤的同时生成资产。

* 在游戏开发中，开发人员通常会在执行编译任务的同时，使用 XiaoBuild 执行其他计算密集型作业（例如着色器编译、渲染等）。使用此并行执行构建功能，开发人员即可在执行着色器编译的同时，继续开发和编译源码，在此期间所色器编译能够正常运行。


> 并发运行 XiaoBuild 执行的注意事项

在同一启动机器上并发运行多个 XiaoBuild 执行时，需要考虑到以下注意事项：

* 确保启动机器能够处理多个作业执行，同时不会在资源（特别是内存消耗、I/O 访问）方面进行过度配置。例如，使用 XiaoBuild 时，链接任务将仅在本地机器上执行。在没有足够内存资源的同一机器上并行执行太多链接任务，可能导致内存不足问题，或引发高交换现象，对性能造成负面影响。

* 如果需要并行执行多个构建，请确保这些构建没有写入相同文件或文件夹。

* 建议尝试启用 XiaoBuild 代理设置 -> Initiator -> General 部分下的“Avoid task execution on local machine as possible”标志。启用此标志能够指导 XiaoBuild 尽可能首选在远端机器上执行任务，将省出的启动机器资源用于执行只能在本地执行的任务，同时释放更多机器资源来服务远端机器的同步请求。



> 限制 XiaoBuild 并发执行的数量

为了便于用户根据机器可用资源，在 Initiator 机器上限制 XiaoBuild 并发执行的数量，两个新标志已添加至 代理设置 -> Initiator -> Multiple Builds。能够并发运行的 XiaoBuild 命令最大数量受限于以下两个值：

Limit number of concurrent builds to（默认为 1，即每次仅允许执行单个构建）- 为了能够并行运行 XiaoBuild 执行，请指定一个大于 1 的值，或直接取消选中此选项。进行此操作后，能够并行运行的 XiaoBuild 执行数量即不会受限。请注意，并发构建的数量仍将受限，限制因素包括此 Agent 的许可核心数量，以及为“minimum number of cores per build”标志（见下文）设置的值。

Minimum local cores per build（默认为 4）- 控制必须处于可用状态的本地核心最小数量（即未被另一 XiaoBuild 执行所占用的核心），以便另一 XiaoBuild 执行能够同时启动。

![](/documents/resource/multiple_build.png)

上图：用于控制 Incredibuild 并发执行功能的 代理设置 标志

示例：现有一个具备 10 个本地核心的机器，将此机器中并发构建的数量限制为 3，并将“Minimum local cores per build”标志设置为 4：

1. 第一个 Incredibuild 执行将使用全部 10 个本地核心（同时使用其他 Helper 核心）。

2. 当第二个 Incredibuild 执行启动时，这 10 个本地核心将在两个 Incredibuild 执行之间平均分配，每个执行使用 5 个核心（同时使用其他 Helper 核心），如此即可满足每构建至少需要 4 个本地核心的要求。两个构建将并行运行。
   
3. 系统不会启动第三个构建，而会将其添加到 Incredibuild 执行队列，因为已没有足够的本地核心可将该构建与其他执行并行启动：如果将 10 个本地核心拆分至 3 个构建（即 4 + 4 + 2），那么末位构建只能分到 2 个本地核心，这并不足以启动新构建，因此，第三个构建必须等某一当前构建运行完成并释放了本地核心后，才可以启动。
请注意，第一个构建不受每构建所需最少本地核心数量的影响。例如，如果机器仅具有两个核心，但所需的最小核心数量为 4，那么单个构建仍可运行，仅使用两个核心即可。